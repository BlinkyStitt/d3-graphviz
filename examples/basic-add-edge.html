<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="//d3js.org/d3.v4.js"></script>
<script src="../node_modules/viz.js/viz.js" type="javascript/worker"></script>
<script src="../build/d3-graphviz.js"></script>
<div id="graph" style="text-align: center;"></div>
<script>

margin = 20; // to avoid scrollbars

var isDrawing = false;
var startNode;

var dotSrc = `strict digraph {
    node [style="filled"]
    a
    b
}`;

var graphviz = d3.select("#graph").graphviz()
    .attributer(attributer)
    .transition(function() {
        return d3.transition().duration(1000);
    })
    .renderDot(dotSrc, startApp);

    function attributer(datum, index, nodes) {
        var selection = d3.select(this);
        if (datum.tag == "svg") {
            var width = window.innerWidth - margin;
            var height = window.innerHeight - margin;
            var x = "10";
            var y = "10";
            var unit = 'px';
            selection
                .attr("width", width + unit)
                .attr("height", height + unit);
            datum.attributes.width = width + unit;
            datum.attributes.height = height + unit;
        }
    }

    function startApp() {
        var nodes = d3.selectAll(".node");

        // click outside of nodes
        d3.select(document).on("click", function() {
            var event = d3.event;
            event.preventDefault();
            event.stopPropagation();
            console.log('document click');
        });

        // keyup outside of nodes
        d3.select(document).on("keyup", function() {
            var event = d3.event;
            event.preventDefault();
            console.log('document keyup', event);
            if (event.keyCode == 27) {
                graphviz.abortDrawing();
            }
            isDrawing = false;
        });

        // move
        d3.select(document).on("mousemove", function() {
            var event = d3.event;
            event.preventDefault();
            event.stopPropagation();
            console.log('document mousemove');
            var graph0 = d3.select("svg").selectWithoutDataPropagation("g");
            [x0, y0] = d3.mouse(graph0.node());
            var shortening = 2; // avoid mouse pointing on edge
            if (isDrawing) {
                graphviz
                    .moveCurrentEdgeEndPoint(x0, y0,  {shortening: shortening})
            }
        });

        // click and mousedown on nodes
        nodes.on("click mousedown", function() {
            var event = d3.event;
            event.preventDefault();
            console.log('node click or mousedown');
        });

        // double-click on nodes
        nodes.on("dblclick", function() {
            var event = d3.event;
            event.preventDefault();
            event.stopPropagation();
            console.log('node dblclick');
            if (isDrawing) {
                var endNode = d3.select(this);
                var startNodeName = startNode.selectWithoutDataPropagation("title").text();
                var endNodeName = endNode.selectWithoutDataPropagation("title").text();
                graphviz
                    .insertCurrentEdge(startNodeName + '->' + endNodeName);
                dotSrcLines = dotSrc.split('\n');
                newEdgeString = startNodeName + ' -> ' + endNodeName + ' [color="red"; fillcolor="orange", penwidth="1", URL="dummy"]';
                dotSrcLines.splice(-1, 0, newEdgeString);
                dotSrc = dotSrcLines.join('\n');
                graphviz
                    .renderDot(dotSrc, startApp);
            }
            isDrawing = false;
        });

        // right-click on nodes
        nodes.on("contextmenu", function() {
            var event = d3.event;
            event.preventDefault();
            event.stopPropagation();
            console.log('node contextmenu');
            startNode = d3.select(this);
            var graph0 = d3.select("svg").selectWithoutDataPropagation("g");
            [x0, y0] = d3.mouse(graph0.node());
            graphviz
                .drawEdge(x0, y0, x0, y0, {fillcolor: "orange", color: "purple"})
            isDrawing = true;
        });

        // right-click outside of nodes
        d3.select(document).on("contextmenu", function() {
            var event = d3.event;
            event.preventDefault();
            event.stopPropagation();
            console.log('document contextmenu');
        });

    }

</script>
